# 18. AWS Well-Architected Full Demo <!-- omit in TOC -->

# Estructura del proyecto
## Root
## Network
## SecurityGroups
## Ec2
## LoadBalancer
## DNS
## AutoscalingGroups

Cada módulo requiere de una carpeta

# Configurar el proveedor AWS y la máquina virtual con las credenciales.
- usar la region: us-east-1
- usar las credenciales provistas para el laboratorio

# Crear las variables del proyecto
## Variables globales (variables.tf)
- lab_name: tipo: string, description: "Nombre del estudiante", condición: no menor de 3 caractéres
- cidr_block: tipo: string, descripcion: bloque de IP's para la VPC
- public_cidr_block: type: string, description = "Bloque de IP's para la subnet pública"
- private_cidr_block: type: string, description = "Bloque de IP's para la subnet privada"
- public_zone: type: string, description = "Zona de acceso público"
- private_zone: type: string, description = "Zona de acceso privado"
## Valores por defecto (terraform.tfvars)
- cidr_block = "10.0.0.0/16"
- public_cidr_block  = "10.0.1.0/24"
- private_cidr_block = "10.0.2.0/24"
- public_zone = "us-east-1a"
- private_zone = "us-east-1b"

# Módulo Network
## Crear VPC
> [VPC](https://github.com/cachac/TerraformLabs/blob/main/18.Workspaces.md#82-servertf)

- usar el CIDR: var.cidr_block
- Agregarle el tag: Name = "VPC ${var.lab_name}"

## Crear subnet pública
- usar el CIDR: var.public.cidr_block
- zona: var.public_zone
## Crear subnet privada
- usar el CIDR: var.private.cidr_block
- zona: var.private_zone

## Crear tablas de enrutamiento y gateways
Para dividir el tráfico de las subnets públicas y privadas se debe configurar:
### Internet Gateway
Para la entrada de tráfico desde internet hacia la Subnet pública
```tf
resource "aws_internet_gateway" "igw" {
  vpc_id = aws_vpc.vpc.id
}
```
### NAT Gateway
Para la salida de tráfico de la subnet privada por medio de la subnet pública
```tf
resource "aws_eip" "nat_elastic_ip" {
  vpc = true
}

resource "aws_nat_gateway" "ngw" {
  depends_on = [aws_internet_gateway.igw]

  allocation_id = aws_eip.nat_elastic_ip.id
  subnet_id     = aws_subnet.public_subnet.id
}
```

### Public Route Tables
```tf
resource "aws_route_table" "rt_igw" {
  depends_on = [aws_internet_gateway.igw, aws_vpc.vpc]
  vpc_id     = aws_vpc.vpc.id
}

# route from 0.0.0.0/0 to igw
resource "aws_route" "publicRoute" {
  depends_on             = [aws_route_table.rt_igw]
  route_table_id         = aws_route_table.rt_igw.id
  destination_cidr_block = "0.0.0.0/0"
  gateway_id             = aws_internet_gateway.igw.id
}

# associations
resource "aws_route_table_association" "public_subnet_association_a" {
  subnet_id      = aws_subnet.public_subnet.id
  route_table_id = aws_route_table.rt_igw.id
}
```

### Private Route Tables
```tf
# route table
resource "aws_route_table" "rt_nat" {
  depends_on = [aws_vpc.vpc, aws_nat_gateway.ngw]

  vpc_id = aws_vpc.vpc.id
}

# route from 0.0.0.0/0 to igw
resource "aws_route" "routeNat" {
  depends_on = [aws_route_table.rt_nat]

  route_table_id         = aws_route_table.rt_nat.id
  destination_cidr_block = "0.0.0.0/0"
  gateway_id             = aws_nat_gateway.ngw.id
}

# associations
resource "aws_route_table_association" "private_subnet_association_a" {
  subnet_id      = aws_subnet.private_subnet.id
  route_table_id = aws_route_table.rt_nat.id
}
```

## Exportar el recurso "aws_vpc.vpc"
Es necesario exportar el recurso aws_vpc para se utilizado en los otros módulos del laboratorio.
```tf
output "vpc" {
  value = aws_vpc.vpc
}

```

# CheckPoint
- llamar el módulo Network en ./main.tf
- pasar las variables necesarias al módulo
- aplicar la configuración del módulo

# SecurityGroups

## Crear una variable (variables.tf) que reciba el VPC del punto anterior
```tf
variable "vpc" {
	type = any
	description = "VPC del laboratorio"
}
```
## Bastion Host
- Ver el ejemplo :
> [aws_security_group](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/security_group)
- permite el tráfico SSH, puerto 22 tcp de entrada desde "0.0.0.0/0"
- permite todo el tráfico de salida
- usar el id de la vpc creada en el paso anterior

Ejemplo Ingress a puerto 22:
```tf
  from_port   = 22
  to_port     = 22
  protocol    = "tcp"
  cidr_blocks = ["0.0.0.0/0"]
```

## Public
- permite el tráfico HTTP, puerto 80 de entrada desde "0.0.0.0/0"
- permite el tráfico HTTPs,puerto 443 de entrada desde "0.0.0.0/0"
- permite todo el tráfico de salida
- usar el id de la vpc creada en el paso anterior
## Private
- permite el tráfico SSH, puerto 22 de entrada desde el security group del Bastion Host
- permite el tráfico HTTP, puerto 80 de entrada desde el security group público
- permite el tráfico HTTPs,puerto 443 de entrada desde el security group público
- permite todo el tráfico de salida
- usar el id de la vpc creada en el paso anterior
