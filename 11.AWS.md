# 10. AWS <!-- omit in TOC -->

## 0.1. Crear la carpeta aws/

## 0.2. Configurar cliente AWS en la máquina virtual.

Pasos de Instalación:
```vim
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
sudo apt install unzip
unzip awscliv2.zip
sudo ./aws/install
```

Utilizar variables de ambiente con los valores de acceso para este laboratorio proporcionados por el instructor

```vim
export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
export AWS_DEFAULT_REGION=${region}
```
## 0.3. Crear archivo main.tf

Crear un usuario en AWS utilizando el recurso aws_iam_user.

Cambiar el nombre de usuario

```tf
resource "aws_iam_user" "users" {
  name = <usuario>
}

resource "aws_iam_user_group_membership" "group-lab" {
  user = aws_iam_user.user.name

  groups = ["min-labs"]
}

resource "aws_iam_access_key" "key" {
  user    = aws_iam_user.user.name
  pgp_key = "keybase:carlosechc11"
}

```
> Crea el usuario y lo asigna a un grupo existente con los permisos mínimos (min-labs).
>
> Asigna llaves de acceso programado.

## 0.4. Agregar a main.tf los outputs para visualizar las llaves de acceso
```tf
output "access_key" {
  value = aws_iam_access_key.key.id
}
output "encrypted_secret" {
  value = aws_iam_access_key.key.encrypted_secret
}
output "user_arn" {
  value = aws_iam_user.user.arn
}
```

El valor **Secret Access Key** es sensible y debe ser desencriptado utilizando Keybase

> terraform output -raw encrypted_secret | base64 --decode | keybase pgp decrypt

>[Mas información](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_access_key)

>[Keybase.io](https://keybase.io/)

>[Instalación Ubuntu](../terraformlabs/demo-files/11.AWS/keybase.config)
## 0.5. Inicializar

> Terraform auto-detecta el proveedor aws



### 0.5.1. Otra alternativa: utilizando aws configure (no recomendado)
```vim
install aws cli
aws configure

# Ejemplo:
AWS Access Key ID []: <mi access key>
AWS Secret Access Key []: <mi secret>
Default region name []: <region, ej: us-east-1>
Default output format [None]: none
```
> La configuración se almacena en la ruta: check: ~/.aws/credentials
>
> Se alamcena **sin cifrar**, por lo tanto debe ser tratado como un archivo sensible

## 0.6. Crear el archivo provider.tf
```tf
provider "aws" {
  region = "us-east-1"
}
```

> [Mas información del recurso aws](https://registry.terraform.io/providers/hashicorp/aws/latest/docs)

## 0.7. Planificar y aplicar
```tf
Apply complete! Resources: 3 added, 0 changed, 0 destroyed.
```

## Destruir los recursos
```vim
terraform destroy
```
